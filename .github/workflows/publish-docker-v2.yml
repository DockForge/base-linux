name: 🐳 Docker Images

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
      
jobs:
    build:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          platform: [amd64, arm64]
  
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
  
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3
  
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
  
        - name: Log in to DockerHub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}
  
        - name: Set Build Args
          run: |
            echo "BUILD_ARGS=TARGETPLATFORM=${{ matrix.platform }}" >> $GITHUB_ENV
            if [ "${{ matrix.platform }}" == "amd64" ]; then
              echo "BUILD_ARGS=${{ env.BUILD_ARGS }} ARCH=x86_64" >> $GITHUB_ENV
            elif [ "${{ matrix.platform }}" == "arm64" ]; then
              echo "BUILD_ARGS=${{ env.BUILD_ARGS }} ARCH=aarch64" >> $GITHUB_ENV
            fi

            
        - name: Fetch Commit SHA
          run: echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
  
        - name: Build Docker Image
          uses: docker/build-push-action@v5.0.0
          with:
            context: ./src
            file: ./src/Dockerfile
            load: true
            platforms: ${{ matrix.platform }}
            tags: dublok/base-linux:alpine-${{ matrix.platform }}-${{ env.SHA_SHORT }}
            build-args: ${{ env.BUILD_ARGS }}

        - name: Verify Image on Registry (Placeholder for actual verification)
          run: sleep 60
    
        - name: Create and Push Manifest
          if: ${{ github.event_name == 'push' }}
          run: |
            DOCKER_CLI_EXPERIMENTAL=enabled docker manifest create dublok/base-linux:alpine-latest \
              --amend dublok/base-linux:alpine-amd64-${{ env.SHA_SHORT }} \
              --amend dublok/base-linux:alpine-arm64-${{ env.SHA_SHORT }}
            DOCKER_CLI_EXPERIMENTAL=enabled docker manifest push dublok/base-linux:alpine-latest
  